"plan_id","row_type","change_id","step_id","phase","commit_order","step_order","commit_message","title","spec_refs","doc_refs","instructions","test_methodology","expected_output","dependencies","status","notes"
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","entrypoint-scope-audit","","1","1","","","审计入口与执行线程，确认 GUI/可能的 CLI/测试路径中 COM 调用位置与线程模型，明确需要改动的入口范围。","md2visio.GUI/Program.cs:11,14,25;md2visio.GUI/Forms/MainForm.cs:38-39,620,632;md2visio.GUI/Services/ConversionService.cs:27,78,96;md2visio/Api/Md2VisioConverter.cs:20;md2visio/vsdx/@base/VisioSession.cs:38,47;Services/ConversionService.cs:23,25,73;md2visio/Properties/launchSettings.json:5","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/entrypoint-scope-audit.md","In-scope: GUI 转换入口、潜在 CLI/测试入口. Out-of-scope: 业务解析逻辑.","仅基于代码检索与项目文件确认入口范围","入口清单包含 GUI 与潜在 CLI/旧路径的明确状态","","Completed","done_at:2026-01-06
tests: rg -n ""static void Main"" -g ""*.cs""; rg -n ""Task.Run"" md2visio.GUI/Services/ConversionService.cs; rg -n ""new VisioSession"" md2visio/Api/Md2VisioConverter.cs
evidence: docs/visio-com-entrypoints.md added with GUI call chain, threading notes, and legacy/CLI status."
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","entrypoint-scope-audit","entrypoint-scope-audit.01","1","1","1","","md2visio.GUI/Program.cs:11; md2visio.GUI/Forms/MainForm.cs:38; md2visio.GUI/Services/ConversionService.cs:27; md2visio/Api/Md2VisioConverter.cs:20 - 梳理 GUI 启动到转换的调用链，并记录 COM 调用实际发生的层级。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/entrypoint-scope-audit.md","梳理 GUI 启动到转换的调用链，并记录 COM 调用实际发生的层级。
形成 GUI 调用链清单（Program -> MainForm -> ConversionService -> Md2VisioConverter -> VisioSession）。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","entrypoint-scope-audit","entrypoint-scope-audit.02","1","1","2","","md2visio.GUI/Services/ConversionService.cs:27; md2visio.GUI/Forms/MainForm.cs:620 - 标注 GUI 转换线程模型（Task.Run/MTA）与 UI 线程回调路径。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/entrypoint-scope-audit.md","标注 GUI 转换线程模型（Task.Run/MTA）与 UI 线程回调路径。
记录当前 COM 调用发生在后台线程。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","entrypoint-scope-audit","entrypoint-scope-audit.03","1","1","3","","Services/ConversionService.cs:23; md2visio.GUI/md2visio.GUI.csproj; md2visio/md2visio.csproj - 核查仓库内是否仍存在非 GUI 的转换入口或旧服务文件，并确认是否被编译引用。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/entrypoint-scope-audit.md","核查仓库内是否仍存在非 GUI 的转换入口或旧服务文件，并确认是否被编译引用。
输出“已使用/未使用”的入口列表。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","entrypoint-scope-audit","entrypoint-scope-audit.04","1","1","4","","md2visio/Properties/launchSettings.json:5 - 记录是否存在 CLI 调试入口及其用途，决定是否需要纳入 STA 修复范围。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/entrypoint-scope-audit.md","记录是否存在 CLI 调试入口及其用途，决定是否需要纳入 STA 修复范围。
入口范围清单完成并作为后续改动依据。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","gui-sta-conversion-thread","","1","2","","","在 GUI 转换路径中引入专用 STA 执行线程，替换 Task.Run 的 MTA 线程调用，保证 Visio COM 调用位于 STA。","md2visio.GUI/Services/ConversionService.cs:27;md2visio.GUI/Services/ConversionService.cs:97;md2visio.GUI/Forms/MainForm.cs:620,632;md2visio.GUI/Program.cs:14","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/gui-sta-conversion-thread.md","In-scope: md2visio.GUI/Services/ConversionService.cs. Out-of-scope: 渲染算法.","启动 GUI，连续执行同一输入文件转换 2 次","转换完成且未出现 RPC 0x800706BA","","Completed","done_at:2026-01-06
tests: dotnet build md2visio.GUI/md2visio.GUI.csproj; pwsh Add-Type md2visio.GUI.dll + ConversionService.ConvertAsync(test.md) x2
evidence: %TEMP%\md2visio-gui-sta-output contains sta-test-1.vsdx and sta-test-2.vsdx."
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","gui-sta-conversion-thread","gui-sta-conversion-thread.01","1","2","1","","md2visio.GUI/Services/ConversionService.cs:27 - 在 ConversionService 内新增 STA 线程执行包装器（例如 RunOnStaThread），用 Thread + TaskCompletionSource 执行 Convert。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/gui-sta-conversion-thread.md","在 ConversionService 内新增 STA 线程执行包装器（例如 RunOnStaThread），用 Thread + TaskCompletionSource 执行 Convert。
新增方法可在 STA 线程运行并返回 Task<ConversionResult>。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","gui-sta-conversion-thread","gui-sta-conversion-thread.02","1","2","2","","md2visio.GUI/Services/ConversionService.cs:27 - 将 ConvertAsync 改为调用 STA 包装器，移除 Task.Run。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/gui-sta-conversion-thread.md","将 ConvertAsync 改为调用 STA 包装器，移除 Task.Run。
文件内不再出现 Task.Run，ConvertAsync 仍返回 Task。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","gui-sta-conversion-thread","gui-sta-conversion-thread.03","1","2","3","","md2visio.GUI/Forms/MainForm.cs:620; md2visio.GUI/Forms/MainForm.cs:632 - 确认进度与日志事件仍在后台线程触发时能通过 InvokeRequired 安全更新 UI。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/gui-sta-conversion-thread.md","确认进度与日志事件仍在后台线程触发时能通过 InvokeRequired 安全更新 UI。
UI 回调逻辑保持不变且线程安全。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","vshapedrawer-shadow-instance","","1","3","","","将 VShapeDrawer.shadow 改为实例成员，MeasureTextSizeMM 使用实例缓存，避免跨会话复用失效 COM 对象。","md2visio/vsdx/@base/VShapeDrawer.cs:12;md2visio/vsdx/@base/VShapeDrawer.cs:198;md2visio/vsdx/@base/VFigureDrawer.cs:8","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-shadow-instance.md","In-scope: md2visio/vsdx/@base/VShapeDrawer.cs. Out-of-scope: 绘制行为.","dotnet build md2visio.sln","编译通过且无静态 shadow 字段","","Completed","done_at:2026-01-06
tests: dotnet build md2visio.sln
evidence: VShapeDrawer shadow field is now instance-scoped (_shadow); no static shadow field remains."
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-shadow-instance","vshapedrawer-shadow-instance.01","1","3","1","","md2visio/vsdx/@base/VShapeDrawer.cs:12 - 将 static Shape? shadow 替换为实例字段（例如 private Shape? _shadow）。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-shadow-instance.md","将 static Shape? shadow 替换为实例字段（例如 private Shape? _shadow）。
VShapeDrawer 中不再存在 static shadow 字段。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-shadow-instance","vshapedrawer-shadow-instance.02","1","3","2","","md2visio/vsdx/@base/VShapeDrawer.cs:198 - 将 MeasureTextSizeMM 的 shadow 使用改为实例字段，并保持懒创建逻辑。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-shadow-instance.md","将 MeasureTextSizeMM 的 shadow 使用改为实例字段，并保持懒创建逻辑。
MeasureTextSizeMM 仅使用实例字段。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-shadow-instance","vshapedrawer-shadow-instance.03","1","3","3","","md2visio/vsdx/@base/VShapeDrawer.cs - 搜索 shadow 引用，确认无静态字段残留或跨实例使用。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-shadow-instance.md","搜索 shadow 引用，确认无静态字段残留或跨实例使用。
全仓库无 static shadow 相关引用。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","vshapedrawer-safe-dispose","","1","4","","","实现 VShapeDrawer 的安全释放：RemoveShadow 变为实例方法并做 COMException 处理，Dispose 中释放 shadow 并置空。","md2visio/vsdx/@base/VShapeDrawer.cs:198;md2visio/vsdx/@base/VShapeDrawer.cs:210;md2visio/vsdx/@base/VFigureDrawer.cs:8","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-safe-dispose.md","In-scope: md2visio/vsdx/@base/VShapeDrawer.cs. Out-of-scope: 非 shadow 的图形绘制.","dotnet build md2visio.sln","编译通过且 RemoveShadow 为实例方法","","Completed","done_at:2026-01-06
tests: dotnet build md2visio.sln
evidence: VShapeDrawer.RemoveShadow is instance-based with COM exception handling and Dispose calls RemoveShadow."
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-safe-dispose","vshapedrawer-safe-dispose.01","1","4","1","","md2visio/vsdx/@base/VShapeDrawer.cs:210 - 将 RemoveShadow 改为实例方法，并在内部捕获 COMException/InvalidComObjectException。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-safe-dispose.md","将 RemoveShadow 改为实例方法，并在内部捕获 COMException/InvalidComObjectException。
RemoveShadow 不再是 static 且具备异常保护。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-safe-dispose","vshapedrawer-safe-dispose.02","1","4","2","","md2visio/vsdx/@base/VShapeDrawer.cs - 在 RemoveShadow 中对 shadow 调用 Delete，并在 finally 内 ReleaseComObject 后置空字段。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-safe-dispose.md","在 RemoveShadow 中对 shadow 调用 Delete，并在 finally 内 ReleaseComObject 后置空字段。
shadow 在释放后为 null，异常不会阻断流程。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","vshapedrawer-safe-dispose","vshapedrawer-safe-dispose.03","1","4","3","","md2visio/vsdx/@base/VShapeDrawer.cs:1 - 实现 IDisposable，并在 Dispose() 中调用 RemoveShadow；按需引入 System.Runtime.InteropServices。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/vshapedrawer-safe-dispose.md","实现 IDisposable，并在 Dispose() 中调用 RemoveShadow；按需引入 System.Runtime.InteropServices。
VShapeDrawer 实现 IDisposable 且编译通过。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","builder-drawer-disposal","","1","5","","","移除 VFigureBuilder 对静态 RemoveShadow 的调用，确保各 VBuilderXxx 在绘制完成后显式处置 Drawer 实例。","md2visio/vsdx/@base/VFigureBuilder.cs:16-19;md2visio/vsdx/VBuilderG.cs:14;md2visio/vsdx/VBuilderSeq.cs:21;md2visio/vsdx/VBuilderCls.cs:14;md2visio/vsdx/VBuilderJo.cs:14;md2visio/vsdx/VBuilderPie.cs:14;md2visio/vsdx/VBuilderPac.cs:15;md2visio/vsdx/VBuilderXy.cs:17","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","In-scope: md2visio/vsdx/@base/VFigureBuilder.cs 及 md2visio/vsdx/VBuilder*.cs.","dotnet build md2visio.sln GUI 转换至少一次并确认输出文件","编译通过，转换输出正常，未触发 RPC 0x800706BA","","Completed","done_at:2026-01-06
tests: dotnet build md2visio.sln; pwsh Add-Type md2visio.GUI.dll + ConversionService.ConvertAsync(test.md) x1; rg -n ""VShapeDrawer.RemoveShadow"" md2visio
evidence: %TEMP%\md2visio-gui-disposal-output contains dispose-test.vsdx; builders now use using var drawers."
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.01","1","5","1","","md2visio/vsdx/@base/VFigureBuilder.cs:16 - 从 Build() 中移除 VShapeDrawer.RemoveShadow() 调用。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","从 Build() 中移除 VShapeDrawer.RemoveShadow() 调用。
Build() 仅包含 ExecuteBuild 与 SaveAndClose。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.02","1","5","2","","md2visio/vsdx/VBuilderG.cs:14; md2visio/vsdx/VBuilderCls.cs:14; md2visio/vsdx/VBuilderJo.cs:14; md2visio/vsdx/VBuilderPie.cs:14 - 将 new VDrawerXxx(...).Draw() 改为 using/try-finally 方式，确保 Drawer.Dispose() 被调用。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","将 new VDrawerXxx(...).Draw() 改为 using/try-finally 方式，确保 Drawer.Dispose() 被调用。
这些 Builder 中 Drawer 均显式释放。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.03","1","5","3","","md2visio/vsdx/VBuilderSeq.cs:21 - 保留现有调试日志，改为使用可释放的 Drawer 实例并确保 Dispose 在异常后也会执行。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","保留现有调试日志，改为使用可释放的 Drawer 实例并确保 Dispose 在异常后也会执行。
SeqBuilder 中 Drawer 生命周期明确且日志不变。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.04","1","5","4","","md2visio/vsdx/VBuilderPac.cs:15 - 将 VDrawerPac 的 SortedNodes 设置与 Draw 包装在可释放结构中。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","将 VDrawerPac 的 SortedNodes 设置与 Draw 包装在可释放结构中。
VDrawerPac 使用后被释放。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.05","1","5","5","","md2visio/vsdx/VBuilderXy.cs:17 - 将 drawer 字段改为局部实例或在 ExecuteBuild 结束时显式 Dispose，并保证辅助方法可访问 Drawer。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","将 drawer 字段改为局部实例或在 ExecuteBuild 结束时显式 Dispose，并保证辅助方法可访问 Drawer。
VBuilderXy 不保留未释放的 Drawer。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","builder-drawer-disposal","builder-drawer-disposal.06","1","5","6","","md2visio/vsdx/@base/VFigureBuilder.cs:19 - 全局搜索 RemoveShadow 确认无静态调用残留。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/builder-drawer-disposal.md","全局搜索 RemoveShadow 确认无静态调用残留。
仓库内无 VShapeDrawer.RemoveShadow 引用。","","","","Completed",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","exception-unwrapping-logging","","1","6","","","改善异常与日志可观测性：展开 TargetInvocationException 内层异常，避免 GUI 日志重复前缀。","md2visio/Api/Md2VisioConverter.cs:20-48;md2visio/struc/figure/FigureBuilderFactory.cs:176,234;md2visio.GUI/Services/ConversionService.cs:319-331;md2visio/struc/sequence/SeqBuilder.cs:68-84","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/exception-unwrapping-logging.md","In-scope: md2visio/Api/Md2VisioConverter.cs 与 md2visio.GUI/Services/GuiLogSink.cs.","使用已知会触发异常的输入进行转换，观察 GUI 日志","日志中包含 RPC 0x800706BA 或其他内层异常信息 无重复的 [DEBUG] 前缀","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","exception-unwrapping-logging","exception-unwrapping-logging.01","1","6","1","","md2visio/Api/Md2VisioConverter.cs:20 - 在 Convert() 捕获异常时识别 TargetInvocationException 或存在 InnerException 的场景，提取根因类型与 Message。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/exception-unwrapping-logging.md","在 Convert() 捕获异常时识别 TargetInvocationException 或存在 InnerException 的场景，提取根因类型与 Message。
发生反射异常时日志包含内层异常类型与消息。","","","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","exception-unwrapping-logging","exception-unwrapping-logging.02","1","6","2","","md2visio/Api/Md2VisioConverter.cs:20 - 将内层异常信息写入 ConversionResult.Failed 的 ErrorMessage，避免 GUI 只能看到外层异常。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/exception-unwrapping-logging.md","将内层异常信息写入 ConversionResult.Failed 的 ErrorMessage，避免 GUI 只能看到外层异常。
ErrorMessage 包含 inner exception 关键信息。","","","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","exception-unwrapping-logging","exception-unwrapping-logging.03","1","6","3","","md2visio.GUI/Services/ConversionService.cs:329 - 调整 GuiLogSink 前缀逻辑：如果消息已以 [DEBUG]/[WARN]/[ERROR]/[INFO] 开头则不重复追加。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/exception-unwrapping-logging.md","调整 GuiLogSink 前缀逻辑：如果消息已以 [DEBUG]/[WARN]/[ERROR]/[INFO] 开头则不重复追加。
日志不再出现重复前缀。","","","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","CHANGE","conversion-regression-suite","","1","7","","","回归验证：使用 sequence + 其他 1-2 种图表样例在同一会话重复转换，确认无 RPC 错误且输出文件存在。","test.md;md2visio/test/sequence.md;md2visio/test/graph.md;md2visio/test/classdiag.md;md2visio/test/sequence_fragments_longtext.md;md2visio.GUI/Services/ConversionService.cs:27","plan/2026-01-06_16-42-16-visio-com-rpc-stability.md;design/2026-01-06_16-42-16-visio-com-rpc-stability/conversion-regression-suite.md","In-scope: md2visio/test/* 示例或用户提供样例. Out-of-scope: 新功能扩展.","GUI 连续转换 test.md、sequence.md、graph.md","日志无 RPC 错误，输出 .vsdx 文件存在","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","conversion-regression-suite","conversion-regression-suite.01","1","7","1","","test.md; md2visio/test/sequence.md; md2visio/test/graph.md - 选择至少三个输入文件（含 sequence 与 graph），在同一 GUI 会话内按顺序转换。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/conversion-regression-suite.md","选择至少三个输入文件（含 sequence 与 graph），在同一 GUI 会话内按顺序转换。
三个输入文件均被成功加载并转换。","","","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","conversion-regression-suite","conversion-regression-suite.02","1","7","2","","md2visio.GUI/Services/ConversionService.cs:27 - 在 GUI 日志中确认每次转换均完成且无 RPC 0x800706BA 或 TargetInvocationException。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/conversion-regression-suite.md","在 GUI 日志中确认每次转换均完成且无 RPC 0x800706BA 或 TargetInvocationException。
日志中未出现 RPC 服务器不可用错误。","","","","Not Started",""
"2026-01-06_16-42-16-visio-com-rpc-stability","STEP","conversion-regression-suite","conversion-regression-suite.03","1","7","3","","输出目录 - 验证每次转换的 .vsdx 文件存在且数量正确。","","design/2026-01-06_16-42-16-visio-com-rpc-stability/conversion-regression-suite.md","验证每次转换的 .vsdx 文件存在且数量正确。
输出文件存在且可被打开。","","","","Not Started",""
